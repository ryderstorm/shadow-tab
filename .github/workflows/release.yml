name: Semantic Release

on:
  workflow_run:
    workflows: ["CI - Tests and Linting"]
    branches:
      - main
    types:
      - completed

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Authenticate with Chainguard Octo STS
        uses: chainguard-dev/actions/octo-sts@main
        with:
          identity: main-semantic-release

      - name: Configure git author
        run: |
          git config user.name "octo-sts[bot]"
          git config user.email "octo-sts[bot]@users.noreply.github.com"

      - name: Set up Python 3.12
        uses: actions/setup-python@v6.1.0
        with:
          python-version: '3.12'

      - name: Install python-semantic-release
        run: |
          pip install "python-semantic-release>=10.0.0,<11.0.0"

      - name: Run semantic-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          semantic-release version --config .releaserc.toml
          semantic-release publish --config .releaserc.toml
          semantic-release changelog --config .releaserc.toml
